# Plugins
import plugins.fec
import plugins.vfake
import plugins.rownum

# Function defs
import re
import os
import functools
import tldextract
import emoji
import string
import nltk
from nltk import word_tokenize
from nltk.util import ngrams
from nltk.corpus import stopwords
from subprocess import call
from dateutil import tz
from dateutil import parser
from geopy.geocoders import Nominatim

to_zone = tz.tzlocal()

geolocator = Nominatim(user_agent="SIO")
geocode = functools.lru_cache(maxsize=65535)(
    functools.partial(geolocator.geocode, timeout=5)
)

# Convert to a more sensible datetime
def time(column):
    return parser.parse(column)


# Same but local time
def ltime(column):
    return parser.parse(column).astimezone(to_zone)


# Do a cached geocode lookup via Nominatim
def coords(column):
    location = geocode(column)
    return str(location.latitude) + " " + str(location.longitude)


# Strip HTML tags
def nohtml(column):
    tag_re = re.compile(r"(<!--.*?-->|<[^>]*>)")
    return tag_re.sub("", column)


# Convert abbreviated numbers like 1.1k to actual numbers
def unk(x):
    if x.isdigit():
        return int(x)
    else:
        if len(x) > 1:
            y = float(x[:-1]) * 1000
    return int(y)


# Convert emoji to :this: representation
def noemoji(column):
    text = emoji.demojize(column)
    return text


# Extract all actual emoji
def gemoji(column):
    text = emoji.demojize(column)
    text = re.findall(r'(:[^:]*:)', text)
    list_emoji = [emoji.emojize(x) for x in text]
    return list_emoji


# Extract text-based emoji
def temoji(column):
    text = emoji.demojize(column)
    text = re.findall(r'(:[^:]*:)', text)
    return text


def hashtags(column):
    return [hashtag["text"] for hashtag in column["hashtags"]]


def mentions(column):
    return [name["screen_name"] for name in column["user_mentions"]]


# Walk Twitter url arrays to extract the most verbose version of the url
def urls(column):
    results = []
    for url in column["urls"]:
        if "unwound_url" in url:
            results.append(url["unwound_url"])
        elif url.get("expanded_url"):
            results.append(url["expanded_url"])
        elif url.get("url"):
            results.append(url["url"])

    return results


# Sloppy ngram filter
def grams(column, n):
    stop = set(stopwords.words('english'))
    w = word_tokenize(column)
    clean = [word for word in w if word.isalnum()]
    tokens = ngrams(clean, n)
    return [ ' '.join(grams) for grams in tokens]


def domains(column):
    return tldextract.extract(column).registered_domain


# These re- functions are for plain text fields where we don't have
# these as separate metadata/columns
def rementions(column):
    return re.findall(r"\B@\w\w+", column)


def reurls(column):
    regex = r"(?i)\b((?:https?://|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'\".,<>?«»“”‘’]))"
    url = re.findall(regex, column)
    return [x[0] for x in url]


def rehashtags(column):
    return re.findall(r"\B#\w\w+", column)


def semis(column):
    return column.split(";")


# Options
options.disp_column_sep = "│"
options.disp_keycol_sep = "║"
options.use_default_colors = True
options.confirm_overwrite = False
options.clipboard_copy_cmd = "pbcopy"
options.clipboard_paste_cmd = "pbpaste"
options.clean_names = True
options.numeric_binning = False
options.disp_ambig_width = 2
options.color_key_col = 110
options.color_note_type = 8
save_filetype = "csv"

# Keybindings
bindkey("0", "go-leftmost")
bindkey("4", "go-rightmost")

# Whether you want binning is pretty context-specific, so these let
# you switch modes
Sheet.addCommand("b", "nobinning", "options.numeric_binning=False")
Sheet.addCommand("B", "binning", "options.numeric_binning=True")

# I keep needing to switch date formats, so make z@ do a "zoom" and show date+time
Sheet.addCommand(
    "@", "shortdate", 'options.disp_date_fmt = "%Y-%m-%d"; cursorCol.type=date'
)
Sheet.addCommand(
    "z@", "longdate", 'options.disp_date_fmt = "%Y-%m-%d %H:%M"; cursorCol.type=date'
)

# See if I can make GitHub highlight properly
# vim: syntax=python
